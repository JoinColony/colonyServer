version: 2

jobs:
  build:
    docker:
      - image: circleci/node:12.13.1
      - image: circleci/mongo:4.2.1
    working_directory: ~/repo
    steps:
      - checkout
        # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run: npm install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}
      - run: npm run typecheck
      - run: 
          name: Run server tests
          command: npm run db:setup && npm test
          environment:
            DB_NAME: 'colonyServer'
            DB_URL: 'mongodb://localhost:27017'
            ETH_NETWORK: 'http://localhost:8545'
            NETWORK_CONTRACT_ADDRESS: '0xde3EDaBA7c15F845F59D1058eCD70Ed33FfdB2b9'
            DISABLE_AUTH_CHECK: true
            JWT_SECRET: 'seeeecret'
            SKIP_EXPIRY_CHECK: true
            APOLLO_PORT: 3000
